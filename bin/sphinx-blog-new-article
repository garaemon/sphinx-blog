#!/usr/bin/env python

"""
usage: sphinx-blog-new-article file-name
"""

import yaml
import sys
import os
import datetime
import re

def datetimeToString(date):
    return "%04d-%02d-%02d-%02d-%02d-%02d" % (date.year,
                                              date.month,
                                              date.day,
                                              date.hour,
                                              date.minute,
                                              date.second)

def usage():
    print __doc__ % vars()

def article_directory(blog_home):
    return os.path.join(blog_home, "articles")

def gen_new_article_rst(full_filepath, title):
    if os.path.exists(full_filepath):
        print "the article you specified already exists"
        exit(3)
    f = open(full_filepath, 'w')
    f.write("""
.. This file is generated by sphinx-blog-new-article
%s
=======
.. Here you write an awesome article
    """ % (title))
    f.close()

def gather_articles(blog_home):
    article_dir = article_directory(blog_home)
    all_files = os.listdir(article_dir)
    # artcile rst format is
    p = re.compile("\d...-\d.-\d.-\d.-\d.-\d.-\w*\.rst")
    articles = [f for f in all_files if re.match(p, f) != None]
    # sort articles!
    articles.sort()
    articles.reverse()
    return articles

def gen_all_articles_rst(blog_home, all_articles):
    all_articles_rst_path = os.path.join(blog_home,
                                         "all_articles.rst")
    f = open(all_articles_rst_path, "w")
    f.write("""
.. This file is auto-generated. DO NOT EDIT THIS!
All Articles
======
""")
    for article in all_articles:
        f.write("articles/" + article + "\n")
    f.close()

def gen_articles_rst(blog_home, article_num):
    article_files = gather_articles(blog_home)
    latest_articles = article_files[:article_num]
    gen_all_articles_rst(blog_home, article_files)
    pass

def gen_articles_rss(blog_home, article_num):
    pass

def main(argv):
    if len(argv) < 2:
        usage()
        exit(1)
    # load configuration from ~/.sphinx-blog
    config_file = os.path.join(os.environ['HOME'], ".sphinx-blog")
    if os.path.exists(config_file):
        config = yaml.load(open(config_file).read())
    else:
        print "You need to have ~/.spinx-blog"
        exit(2)
    now = datetime.datetime.today()
    filename = "%s-%s.rst" % (datetimeToString(now), argv[1])
    blog_home = os.path.expanduser(config['blog_home'])
    full_filepath = os.path.join(article_directory(blog_home),
                                 filename)
    gen_new_article_rst(full_filepath, argv[1])
    gen_articles_rst(blog_home, config['max_latest_article_num'])
    gen_articles_rss(blog_home, config['max_latest_article_num'])
    
    print "generated %s, edit it!" % (full_filepath)


if __name__ == "__main__":
    main(sys.argv)
